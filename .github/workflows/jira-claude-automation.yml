name: Jira Claude Automation

on:
  repository_dispatch:
    types: [jira-task]
jobs:
  validate-payload:
    runs-on: ubuntu-latest
    outputs:
      is_valid: ${{ steps.validate.outputs.is_valid }}
    steps:
      - name: Validate Jira payload
        id: validate
        run: |
          if [ -z "${{ github.event.client_payload.issue_key }}" ]; then
            echo "Missing issue_key"
            echo "is_valid=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          if [ -z "${{ github.event.client_payload.summary }}" ]; then
            echo "Missing summary"
            echo "is_valid=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "is_valid=true" >> $GITHUB_OUTPUT

  process-jira-task:
    needs: validate-payload
    if: needs.validate-payload.outputs.is_valid == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create feature branch
        id: branch
        run: |
          ISSUE_KEY="${{ github.event.client_payload.issue_key }}"
          BRANCH_NAME="jira/${ISSUE_KEY,,}"

          # Check if branch already exists
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME already exists, checking out"
            git fetch origin "$BRANCH_NAME"
            git checkout "$BRANCH_NAME"
          else
            echo "Creating new branch $BRANCH_NAME"
            git checkout -b "$BRANCH_NAME"
          fi

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Jira Ticket: ${{ github.event.client_payload.issue_key }}

            Title: ${{ github.event.client_payload.summary }}

            Description:
            ${{ github.event.client_payload.description }}

            Instructions:
            - Implement this task following the project standards
            - Follow the CLAUDE.md guidelines
            - Make minimal, focused changes
            - Do not create unnecessary files
            - Only add new features, do not delete or refactor existing code unless explicitly required
          claude_args: '--allowedTools "Read,Write,Edit,Glob,Grep,TodoWrite"'

      - name: Check for changes
        id: changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          fi

      - name: Commit changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git commit -m "feat(${{ github.event.client_payload.issue_key }}): ${{ github.event.client_payload.summary }}"

      - name: Push branch
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git push origin "${{ steps.branch.outputs.branch_name }}" --force-with-lease

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if PR already exists
          EXISTING_PR=$(gh pr list --head "${{ steps.branch.outputs.branch_name }}" --json number --jq '.[0].number' || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists, updating..."
            gh pr edit "$EXISTING_PR" \
              --title "${{ github.event.client_payload.issue_key }}: ${{ github.event.client_payload.summary }}"
          else
            echo "Creating new PR..."
            gh pr create \
              --title "${{ github.event.client_payload.issue_key }}: ${{ github.event.client_payload.summary }}" \
              --body "$(cat << 'PR_BODY_EOF'
          ## Jira Ticket
          [${{ github.event.client_payload.issue_key }}](${{ github.event.client_payload.issue_url }})

          ## Summary
          ${{ github.event.client_payload.summary }}

          ## Description
          ${{ github.event.client_payload.description }}

          ---
          > **Note:** This PR was automatically generated by Claude Code based on the Jira ticket.
          > Please review all changes carefully before merging.
          PR_BODY_EOF
          )" \
              --base main \
              --draft
          fi

      - name: Post summary
        if: always()
        run: |
          echo "## Jira Claude Automation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Jira Issue:** ${{ github.event.client_payload.issue_key }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ steps.branch.outputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes detected:** ${{ steps.changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
