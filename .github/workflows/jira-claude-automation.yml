name: Jira Claude Automation

on:
  repository_dispatch:
    types: [jira-task]

jobs:
  validate-payload:
    runs-on: ubuntu-latest
    outputs:
      is_valid: ${{ steps.validate.outputs.is_valid }}
    steps:
      - name: Validate Jira payload
        id: validate
        run: |
          if [ -z "${{ github.event.client_payload.issue_key }}" ]; then
            echo "Missing issue_key"
            echo "is_valid=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          if [ -z "${{ github.event.client_payload.summary }}" ]; then
            echo "Missing summary"
            echo "is_valid=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "is_valid=true" >> $GITHUB_OUTPUT

  process-jira-task:
    needs: validate-payload
    if: needs.validate-payload.outputs.is_valid == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --allowedTools "Edit,Write,Read,Glob,Grep,Bash(npm run build),Bash(npm install)"
          prompt: |
            Jira Ticket: ${{ github.event.client_payload.issue_key }}

            Title: ${{ github.event.client_payload.summary }}

            Description:
            ${{ github.event.client_payload.description }}

            Instructions:
            - Implement this task following the project standards
            - Follow the CLAUDE.md guidelines
            - Make minimal, focused changes
            - Do not create unnecessary files
            - Do NOT commit or push changes, just edit the files

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat(${{ github.event.client_payload.issue_key }}): ${{ github.event.client_payload.summary }}"
          branch: "jira/${{ github.event.client_payload.issue_key }}"
          title: "${{ github.event.client_payload.issue_key }}: ${{ github.event.client_payload.summary }}"
          body: |
            ## Jira Ticket
            [${{ github.event.client_payload.issue_key }}](${{ github.event.client_payload.issue_url }})

            ## Summary
            ${{ github.event.client_payload.summary }}

            ## Description
            ${{ github.event.client_payload.description }}

            ---
            > **Note:** This PR was automatically generated by Claude Code based on the Jira ticket.
          draft: true

      - name: Post summary
        if: always()
        run: |
          echo "## Jira Claude Automation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Jira Issue:** ${{ github.event.client_payload.issue_key }}" >> $GITHUB_STEP_SUMMARY
