name: Jira Claude Automation

on:
  repository_dispatch:
    types: [jira-task]

jobs:
  validate-payload:
    runs-on: ubuntu-latest
    outputs:
      is_valid: ${{ steps.validate.outputs.is_valid }}
    steps:
      - name: Validate Jira payload
        id: validate
        run: |
          if [ -z "${{ github.event.client_payload.issue_key }}" ]; then
            echo "Missing issue_key"
            echo "is_valid=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          if [ -z "${{ github.event.client_payload.summary }}" ]; then
            echo "Missing summary"
            echo "is_valid=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "is_valid=true" >> $GITHUB_OUTPUT

  process-jira-task:
    needs: validate-payload
    if: needs.validate-payload.outputs.is_valid == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create feature branch
        id: branch
        run: |
          ISSUE_KEY="${{ github.event.client_payload.issue_key }}"
          BRANCH_NAME="jira/${ISSUE_KEY,,}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          # Fetch latest main and create branch from it
          git fetch origin main

          # Check if branch already exists
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME already exists, checking out"
            git fetch origin "$BRANCH_NAME"
            git checkout "$BRANCH_NAME"
          else
            echo "Creating new branch $BRANCH_NAME from origin/main"
            git checkout -b "$BRANCH_NAME" origin/main
          fi

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          allowed_tools: "Read,Write,Edit,Glob,Grep,Bash"
          prompt: |
            Jira Ticket: ${{ github.event.client_payload.issue_key }}

            Title: ${{ github.event.client_payload.summary }}

            Description:
            ${{ github.event.client_payload.description }}

            Instructions:
            - Implement this task following the project standards
            - Follow the CLAUDE.md guidelines
            - Make minimal, focused changes
            - Do not create unnecessary files
            - Only add new features, do not delete or refactor existing code unless explicitly required

      - name: Check for changes and commit
        id: changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
            git commit -m "feat(${{ github.event.client_payload.issue_key }}): ${{ github.event.client_payload.summary }}"
            git push origin ${{ steps.branch.outputs.branch_name }}
            echo "Changes committed and pushed to ${{ steps.branch.outputs.branch_name }}"
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        id: create-pr
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const branchName = '${{ steps.branch.outputs.branch_name }}';
            const issueKey = '${{ github.event.client_payload.issue_key }}';
            const summary = '${{ github.event.client_payload.summary }}';
            const description = `${{ github.event.client_payload.description }}`;
            const issueUrl = '${{ github.event.client_payload.issue_url }}';

            // Check if PR already exists
            const { data: existingPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branchName}`,
              state: 'open'
            });

            if (existingPRs.length > 0) {
              console.log(`PR #${existingPRs[0].number} already exists, updating...`);
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: existingPRs[0].number,
                title: `${issueKey}: ${summary}`
              });
              core.setOutput('pr_number', existingPRs[0].number);
              core.setOutput('pr_url', existingPRs[0].html_url);
            } else {
              console.log('Creating new PR...');
              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `${issueKey}: ${summary}`,
                head: branchName,
                base: 'main',
                draft: true,
                body: `## Jira Ticket
            [${issueKey}](${issueUrl})

            ## Summary
            ${summary}

            ## Description
            ${description}

            ---
            > **Note:** This PR was automatically generated by Claude Code based on the Jira ticket.
            > Please review all changes carefully before merging.`
              });
              console.log(`Created PR #${pr.number}: ${pr.html_url}`);
              core.setOutput('pr_number', pr.number);
              core.setOutput('pr_url', pr.html_url);
            }

      - name: Post summary
        if: always()
        run: |
          echo "## Jira Claude Automation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Jira Issue:** ${{ github.event.client_payload.issue_key }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ steps.branch.outputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes detected:** ${{ steps.changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "- **PR:** ${{ steps.create-pr.outputs.pr_url }}" >> $GITHUB_STEP_SUMMARY
          fi
